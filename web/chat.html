<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Cache-Control" content="max-age" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>聊天室</title>
    <style type="text/css">
      body {
        background: url("img/chat.png") no-repeat center;
      }

      * {
        margin: 0;
        padding: 0;
      }

      #allBox {
        width: 100%;
        height: calc(100vh - 75px);
        padding: 5px 6px 35px 6px;
        border: 1px solid #4079a9;
        position: relative;
        margin: 0 auto;
      }

      li {
        list-style: none;
        overflow: hidden;
        width: 65%;
        margin: 10px 10px;
      }

      span {
        padding: 8px;
        border-radius: 5px;
        float: left;
        color: white;
        background-color: rgba(1, 139, 141, 0.7);
      }

      #content {
        height: calc(100vh - 90px);
        overflow-y: auto;
        border: 1px dashed #c5c7ca;
      }

      textarea {
        width: calc(100vw - 110px);
        height: 27px;
        border: 1px solid #7192c7;
        margin-top: 9px;
        resize: vertical;
        font-size: 16px;
      }

      input[type="submit"] {
        width: 68px;
        height: 27px;
        position: absolute;
        right: 6px;
        margin-top: 10px;
      }

      input[type="button"] {
        width: 50px;
        height: 27px;
      }

      input {
        border: none;
      }
    </style>
  </head>
  <body style="margin: 0 auto; padding: 10px 25px 0px 10px">
    <div id="allBox">
      <ul id="content"></ul>
      <textarea id="editContent" maxlength="100"></textarea>
      <input type="submit" value="发送" id="send" />
    </div>
    <script type="text/javascript">
      let time = new Date(),
        user = "User" + time.getHours() + time.getMinutes() + time.getSeconds(),
        ws = "",
        cont = document.getElementById("content"),
        txar = document.getElementById("editContent"),
        send = document.getElementById("send");

      let arrStr = [
        "1F349",
        "1F34A",
        "1F34B",
        "1F34C",
        "1F34D",
        "1F34E",
        "1F34F",
        "1F351",
        "1F352",
        "1F356",
      ];
      showMsg(
        "系统：欢迎光临！<br>言语有礼，交流有心；<br>发言友善，沟通文明。",
        false,
      );

      function WebSocketForChat() {
        if ("WebSocket" in window) {
          const hostPort = "ws://" + location.host + "/ws";
          ws = new WebSocket(hostPort);

          ws.onopen = function () {
            let sendObj = {
              type: "chat",
              data: user + "进入聊天室",
            };

            ws.send(JSON.stringify(sendObj));
          };

          ws.onmessage = function (evt) {
            if (evt.data) {
              let msg = JSON.parse(evt.data);
              showMsg(msg.data, msg.data.indexOf(user) !== -1);
            }
          };

          ws.onclose = function () {
            // 关闭 websocket
            console.log("连接已关闭...");
          };
        } else {
          alert("您的浏览器不支持 WebSocket!");
        }
      }

      send.onclick = function () {
        if (!ws) {
          alert("未连接聊天室");
          return false;
        }

        if (txar.value === "") {
          return false;
        }

        let sendObj = {
          type: "chat",
          data: user + ": " + txar.value,
        };

		showMsg(txar.value, true);
        ws.send(JSON.stringify(sendObj));
        txar.value = "";
      };

      document.onkeydown = function (ev) {
        ev = ev || window.event;
        if (ev.keyCode === 13 && ev.ctrlKey) {
          send.click();
        }
      };

      function showMsg(msg, isMe) {
        let flag =
          "&#x" + arrStr[Math.floor(Math.random() * arrStr.length)] + ";";
        let span = document.createElement("span"),
          li = document.createElement("li");

        if (isMe) {
          li.style.float = "right";
          span.style.float = "right";
          span.style.backgroundColor = "rgba(0, 128, 0, 0.6)";
          span.innerHTML = msg + flag;
        } else {
          span.innerHTML = flag + msg;
        }

        li.appendChild(span);
        cont.appendChild(li);
        cont.scrollTop = cont.scrollHeight;
      }

      WebSocketForChat();
    </script>
  </body>
</html>
